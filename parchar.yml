---
- name: Un playbook muy muy sencillo
  hosts: web1
  become: yes
  tasks:
    - name: Ensure SSH MaxStartups is configured
      block:
      - name: Check for duplicate values
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*MaxStartups\s+
          state: absent
        check_mode: true
        changed_when: false
        register: dupes
      - name: Deduplicate values from /etc/ssh/sshd_config
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*MaxStartups\s+
          state: absent
        when: dupes.found is defined and dupes.found > 1
      - name: Insert correct line to /etc/ssh/sshd_config
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*MaxStartups\s+
          line: MaxStartups 10:30:60
          state: present
          insertbefore: BOF
          validate: /usr/sbin/sshd -t -f %s
      tags:
      - CCE-90718-8

    - name: Ensure cyrus-imapd is removed
      package:
        name: cyrus-imapd
        state: absent
      tags:
      - CCE-88119-3
      
    - name: Ensure nginx is removed
      package:
        name: nginx
        state: absent
      tags:
      - CCE-88034-4

    - name: Enable SSH Warning Banner
      block:
      - name: Check for duplicate values
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*Banner\s+
          state: absent
        check_mode: true
        changed_when: false
        register: dupes
      - name: Deduplicate values from /etc/ssh/sshd_config
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*Banner\s+
          state: absent
        when: dupes.found is defined and dupes.found > 1
      - name: Insert correct line to /etc/ssh/sshd_config
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*Banner\s+
          line: Banner /etc/issue.net
          state: present
          insertbefore: BOF
          validate: /usr/sbin/sshd -t -f %s
      tags:
      - CCE-87978-3 

    - name: Remove /etc/at.deny
      file:
        path: /etc/at.deny
        state: absent
      tags:
      - CCE-86945-3 
       
    - name: Remove /etc/cron.deny
      file:
        path: /etc/cron.deny
        state: absent
      tags:
      - CCE-86849-7
